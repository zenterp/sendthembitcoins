<div id='homePage' style='display:none'>
  <h2 style="text-align:center;margin-top:150px; margin-bottom:70px">
    It is so easy they don't even need a bitcoin wallet!
  </h2>

  <div data-href="/twitter/gifts/new" class='sexyButton' style='margin-bottom:50px'>
    <i class="icon-twitter icon-large icon"></i> 
    Send via Twitter
  </div>
</div>

<div id='claimableGifts' style='display:none'>
  <p style='text-align:center'>Tap Gift to Claim</p>
  <ul></ul>
</div>

<script type='text/template' id='giftListItem'>
  <li>
    <a class='amount'>{{= bitcoin_amount }} bit to {{= recipient_twitter_username }}</a>
  </li>
</script>

<form style='display:none' method='post' id='newInvoice' action='/api/invoices' novalidate>
  <p class='input'>Twitter Username of Recipeient:</p>
  <input name='recipient_twitter_username' step='0.001' min='0.001' required='true' type='text'></input>

  <p class='input'>Number of Bitcoins to Send</p>
  <input type='number' name='bitcoin_amount' style='margin-left:6px'></input>

  <br/><br/>

  <input type='submit' value='next' class='sexyButton small'></input>
</form>

<% if (session[:provider] == 'twitter' || session[:provider] == :twitter) %>
    <% if  @gifts.count > 1 %>
      <h3 style='overflow-y;hidden;text-align:center;max-height:40px;'><span style='width:100%'>Gifts people sent to you via <%= session[:provider] %></span></h3>

      <table>
        <tbody class='table table-striped'>
            <% @gifts.flatten.each do |gift| %>
            <tr>
                <td><%= gift.recipient_twitter_username %></td>
                <td><%= gift.bitcoin_amount %> btc</td>
                <td><%= gift.funded_at.strftime("%D at %H:%M:%S") %></td>
              
                <% if !gift.retrieved_at.nil? %>
                <td><%= gift.retrieved_at.strftime("%D at %H:%M:%S") %></td>                                      
                <% end %>

              <td><button class='btn btn-positive'>Claim Gift</button></td>

            </tr>
            <% end %>
        </tbody>
      </table>
    <% else %>
  <% end %>
<% else %>
  <p style='padding-top:20px;margin-top:20px;text-align:center; font-size:150%'>or <a href='/auth/twitter' id='twitterLogin'>Login with Twitter</a> to Claim Gifts</p>
<% end %>


<% content_for :javascripts do %>
  <script>

    $(function(){

      var Growl = (function() {
        function show() {
        }

        function setText() {
        }

        function Hide() {
        }

        return {
          show: show,
          setText: setText,
          hide: hide
        }
      })

      function Invoice (recipient_twitter_username, bitcoin_amount) { 
        this.recipient_twitter_username = recipient_twitter_username;
        this.bitcoin_amount = bitcoin_amount;
      };

      Invoice.prototype.create = function () {
        var invoice = this;
        $.ajax({
          type: 'POST',
          url: '/api/gifts/twitter',
          data: {
            recipient_twitter_username: invoice.recipient_twitter_username,
            bitcoin_amount: invoice.bitcoin_amount
          },
          success: function(data) {
            invoice.display(data.invoiceUrl);
          },
          error: function(err){
            console.log(err);
          }
        })
      };

      Invoice.prototype.display = function (url) {
        if (window.plugins && window.plugins.childBrowser) {
          invoiceChildBrowser = window.plugins.childBrowser.showWebPage(url, {
            showLocationBar: true
          });

          invoiceChildBrowser.onLocationChange = function(loc) {
            if (loc.match(/^http:\/\/sendthembitcoins.herokuapp.com\/coinbase\/payments/)) {
              invoiceChildBrowser.close();
            } else {
              invoiceChildBrowser.close();
            }
          }

        } else {
          document.location.href = url;
        }
      }

      var Gift = Backbone.Model.extend({
        claim: function(bitcoin_address, callback) {
          id = this.get('id');
          $.ajax({
            type: "POST",
            beforeSend: function(xhr) {
              var token = $('meta[name="csrf-token"]').attr('content');
              xhr.setRequestHeader('X-CSRF-Token', token);
            },
            url: '/api/user/gifts/'+id+'/claim',
            data: {
              receive_address: bitcoin_address
            },
            success: function(data) {
              callback(data);
            }
          });
        }
      });

      var Gifts = Backbone.Collection.extend({
        model: Gift
      });

      var gifts = new Gifts();
      gifts.url = '/api/user/gifts/claimable';
      window.gifts = gifts;

      var giftListItemTemplate = _.template($("#giftListItem").html());

      var AppRouter = Backbone.Router.extend({
        routes: {
          '' : 'index',
          'twitter/gifts/new' : 'newGift',
          'gifts/claimable' : 'gifts'
        },

        index: function() {
          $('#newInvoice').hide();
          $('#homePage').show();
        },
        newGift: function() {
          $('#homePage').hide();
          $('#newInvoice').show();
        },
        gifts: function () {
          $('#homePage').hide();
          $('#newInvoice').hide();
          gifts.fetch({
            success: function (data) {
              for (i=0;i<gifts.models.length;i++) {

                var gift = gifts.models[i];
                li = giftListItemTemplate(gift.attributes);
                $("#claimableGifts ul").append(li);
                $('#claimableGifts').show();
              }
              
            }
          })
        }
      });

      window.app = new AppRouter;

      handleButtonClick = function(e) {
        e.preventDefault();
        app.navigate('twitter/gifts/new', {trigger: true});
      }

      $('#homePage .sexyButton').on('click', handleButtonClick);
      $('#newInvoice').on('submit', function(e) {
        e.preventDefault();
        var recipient_twitter_username = $('input[name="recipient_twitter_username"]').val();
        var bitcoin_amount = $('input[name="bitcoin_amount"]').val();
        var invoice = new Invoice(recipient_twitter_username, bitcoin_amount);
        invoice.create();
      })

      if (window.plugins && window.plugins.childBrowser) {
        $('#twitterLogin').on('click', function(e) {
          e.preventDefault();
          window.plugins.childBrowser.showWebPage('/auth/twitter', {
            showLocationBar: true
          });
        })
      }

      Backbone.history.start({
        pushState: true,
        silent: false
      });

    });
  </script>
<% end %>